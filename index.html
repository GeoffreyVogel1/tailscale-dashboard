<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Makalu</title>
  <style>
    :root {
      --bg: #1e1e2f;
      --card-bg: #2c2c3c;
      --text: #f0f0f0;
      --accent: #ffd166;
      --link: #06d6a0;
    }
    [data-theme="light"] {
      --bg: #f0f0f0;
      --card-bg: #ffffff;
      --text: #1e1e2f;
      --accent: #e07a5f;
      --link: #007acc;
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .main-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .center-title {
      flex: 1;
      text-align: center;
      font-size: 1.8em;
      color: var(--accent);
      margin: 0;
      min-width: 200px;
    }
    .subheader {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }
    #datetime {
      font-size: 0.95em;
      min-width: 150px;
    }
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-left: 5px;
      background-color: gray;
    }
    .cards-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      width: 100%;
      max-width: 1024px;
    }
    .card {
      background: var(--card-bg);
      border-radius: 10px;
      padding: 20px;
      width: 300px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      flex-shrink: 0;
    }
    .weather-day {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0;
      text-align: left;
    }
    .weather-day span {
      flex: 1;
    }
    a {
      color: var(--link);
      text-decoration: none;
      font-weight: bold;
    }
    a:hover {
      text-decoration: underline;
    }
    .toggle-btn {
      background: none;
      border: 2px solid var(--link);
      padding: 5px 10px;
      color: var(--link);
      border-radius: 8px;
      cursor: pointer;
      min-width: 100px;
    }
    footer {
      position: absolute;
      bottom: 10px;
      right: 20px;
      font-size: 0.8em;
      color: var(--text);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .cards-container {
        max-width: 720px;
      }
      .card {
        width: 45%;
      }
    }
    @media (max-width: 600px) {
      .main-header, .subheader {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      #datetime, .center-title, .right-top {
        min-width: auto;
        text-align: center;
      }
      .cards-container {
        max-width: 100%;
        gap: 15px;
      }
      .card {
        width: 100%;
      }
      .toggle-btn {
        width: 100%;
        max-width: 300px;
      }
    }
  </style>
</head>
<body>

  <header class="main-header">
    <div class="left-top" id="datetime">Chargement...</div>
    <h1 class="center-title">Dashboard MAKALU</h1>
    <div class="right-top">
      <span>Home <span class="status-dot" id="home-status"></span></span>
    </div>
  </header>

  <div class="subheader">
    <div class="tailscale-link">
      <a href="https://login.tailscale.com/admin/machines" target="_blank">‚Üí Voir l‚Äôinterface Tailscale</a>
    </div>
    <button class="toggle-btn" onclick="toggleTheme()">Clair/Sombre</button>
  </div>

  <div class="cards-container">
    <div class="card">
      <h2>Plex</h2>
      <a href="http://nas.tail044b6.ts.net:32400/web" target="_blank">Plex</a>
    </div>

    <div class="card">
      <h2>Radarr</h2>
      <a href="http://nas.tail044b6.ts.net:7878" target="_blank">Radarr</a>
    </div>

    <div class="card">
      <h2>Lidarr</h2>
      <a href="http://nas.tail044b6.ts.net:8686" target="_blank">Lidarr</a>
    </div>

    <div class="card">
      <h2>Sonarr</h2>
      <a href="http://nas.tail044b6.ts.net:8989" target="_blank">Sonarr</a>
    </div>

    <div class="card">
      <h2>Tautulli</h2>
      <a href="http://nas.tail044b6.ts.net:8181" target="_blank">Tautulli</a>
    </div>

    <div class="card">
      <h2>qBittorrent</h2>
      <a href="http://nas.tail044b6.ts.net:8080" target="_blank">qBittorrent</a>
    </div>

    <div class="card">
      <h2>Home Assistant</h2>
      <a href="http://nas.tail044b6.ts.net:8123" target="_blank">Home Assistant</a>
    </div>

    <div class="card">
      <h2>Bureau √† distance - PC Gaming</h2>
      <p>Utilise <code>pc-gaming.tail044b6.ts.net:3389</code> dans ton app RDP.</p>
    </div>

    <div class="card" id="weather-card">
      <h2>M√©t√©o locale</h2>
      <div id="weather-content">Chargement m√©t√©o...</div>
    </div>
  </div>

  <footer>¬© bayx.org</footer>

  <script>
    function updateDateTime() {
      const now = new Date();
      const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
      const date = now.toLocaleDateString('fr-FR', options);
      let hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12 || 12;
      const time = `${hours}:${minutes} ${ampm}`;
      document.getElementById('datetime').textContent = `${date} ‚Äì ${time}`;
    }
    setInterval(updateDateTime, 1000);
    updateDateTime();

    function toggleTheme() {
      const current = document.body.getAttribute("data-theme");
      document.body.setAttribute("data-theme", current === "light" ? "dark" : "light");
    }
    document.body.setAttribute("data-theme", "dark");

    async function checkPing() {
      const status = document.getElementById('home-status');
      try {
        await fetch("https://www.google.com", { mode: "no-cors" });
        status.style.backgroundColor = "limegreen";
      } catch (e) {
        status.style.backgroundColor = "red";
      }
    }
    checkPing();
    setInterval(checkPing, 30000);

    function getWeatherIcon(desc) {
      desc = desc.toLowerCase();
      if (desc.includes("sun") || desc.includes("soleil")) return "‚òÄÔ∏è";
      if (desc.includes("cloud") || desc.includes("nuage")) return "‚òÅÔ∏è";
      if (desc.includes("rain") || desc.includes("pluie")) return "üåßÔ∏è";
      if (desc.includes("snow") || desc.includes("neige")) return "‚ùÑÔ∏è";
      return "üåà";
    }

    async function fetchWeather() {
      try {
        if (!navigator.geolocation) throw new Error("G√©olocalisation non support√©e");

        const getPosition = () =>
          new Promise((res, rej) =>
            navigator.geolocation.getCurrentPosition(res, rej, { timeout: 10000 })
          );

        const pos = await getPosition();
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        const corsProxy = "https://corsproxy.io/?";
        const weatherRes = await fetch(`${corsProxy}https://wttr.in/${lat},${lon}?format=j1`);
        if (!weatherRes.ok) throw new Error("Erreur fetch m√©t√©o");

        const weather = await weatherRes.json();

        const city = weather.nearest_area?.[0]?.areaName?.[0]?.value || "Localisation";

        const forecast = weather.weather.slice(0, 3).map(day => {
          const dateObj = new Date(day.date);
          const weekday = dateObj.toLocaleDateString('fr-FR', { weekday: 'long' });
          const hour = day.hourly[4];
          const icon = getWeatherIcon(hour.weatherDesc[0].value);
          return `<div class="weather-day">
            <span>${weekday}</span>
            <span>${icon}</span>
            <span>${day.mintempC}¬∞C - ${day.maxtempC}¬∞C</span>
            <span>${hour.chanceofrain}% üåßÔ∏è</span>
          </div>`;
        }).join('');

        document.getElementById("weather-content").innerHTML = `<div><strong>${city}</strong></div>${forecast}`;
      } catch (e) {
        console.warn("G√©oloc navigateur failed or wttr.in CORS issue, fallback ipapi", e);

        try {
          const geo = await fetch("https://ipapi.co/json");
          if (!geo.ok) throw new Error("Erreur fetch ipapi");
          const loc = await geo.json();
          const city = loc.city;

          const corsProxy = "https://corsproxy.io/?";
          const weatherRes = await fetch(`${corsProxy}https://wttr.in/${city}?format=j1`);
          if (!weatherRes.ok) throw new Error("Erreur fetch m√©t√©o ipapi fallback");

          const weather = await weatherRes.json();

          const forecast = weather.weather.slice(0, 3).map(day => {
            const dateObj = new Date(day.date);
            const weekday = dateObj.toLocaleDateString('fr-FR', { weekday: 'long' });
            const hour = day.hourly[4];
            const icon = getWeatherIcon(hour.weatherDesc[0].value);
            return `<div class="weather-day">
              <span>${weekday}</span>
              <span>${icon}</span>
              <span>${day.mintempC}¬∞C - ${day.maxtempC}¬∞C</span>
              <span>${hour.chanceofrain}% üåßÔ∏è</span>
            </div>`;
          }).join('');

          document.getElementById("weather-content").innerHTML = `<div><strong>${city}</strong></div>${forecast}`;
        } catch (e2) {
          console.error("Fallback m√©t√©o a aussi foir√©", e2);
          document.getElementById("weather-content").textContent = "Erreur de chargement m√©t√©o.";
        }
      }
    }

    fetchWeather();

    /*
    // Test m√©t√©o simple √† coller dans console navigateur :
    // fetch('https://corsproxy.io/?https://wttr.in/Paris?format=j1')
    //   .then(res => res.json())
    //   .then(data => console.log('Test m√©t√©o Paris OK:', data))
    //   .catch(err => console.error('Erreur fetch m√©t√©o:', err));
    */
  </script>
</body>
</html>
